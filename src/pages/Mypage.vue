<template>
  <div>
    <MypageLayout v-if="user">
      <template v-slot:title-area>
        <h2>마이페이지</h2>
        <p>회원 정보 및 설정을 관리하세요</p>
      </template>

      <template v-slot:profile-area>
        <div class="user-image">
          <img
            src="https://velog.velcdn.com/images/chanmi125/post/18a3256c-dbaf-4f5e-952e-c694496e25ad/image.svg"
            alt=""
          />
        </div>
        <div class="info">
          <div class="user-name">
            <template v-if="isEditing">
              <input type="text" v-model="editedNickname" />
            </template>
            <template v-else>
              {{ nickname }}
            </template>
          </div>
          <div class="user-email">{{ email }}</div>
          <div class="user-join-date">{{ joinDate }}</div>
        </div>
        <div class="btn-modi">
          <button
            class="btn btn-primary pointer"
            @click="isEditing ? saveNickname() : modiNickname()"
          >
            {{ isEditing ? '완료' : '수정' }}
          </button>
        </div>
      </template>

      <template v-slot:alarm-area>
        <div>알림 설정</div>
        <hr />
        <div
          class="switch-setting"
          v-for="(label, key) in alarmLabels"
          :key="key"
        >
          <label
            class="form-check-label justify-content-end pointer"
            :for="key"
          >
            {{ label }}
          </label>
          <span class="form-check form-switch">
            <input
              class="form-check-input pointer"
              type="checkbox"
              role="switch"
              :id="key"
              :checked="user[key]"
            />
          </span>
        </div>
      </template>

      <template v-slot:manage-area>
        계정 관리
        <div class="d-flex flex-column gap-2 mt-2">
          <button
            class="btn btn-passwordChange"
            @click="showPasswordChangeModal = true"
          >
            비밀번호 변경
          </button>
          <PasswordChangeModal
            v-if="showPasswordChangeModal"
            :userId="user.id"
            @close="showPasswordChangeModal = false"
          />
          <button class="btn btn-logout">로그아웃</button>
          <button class="btn btn-out" @click="deleteUser">회원 탈퇴</button>
        </div>
      </template>
    </MypageLayout>
  </div>
</template>

<script setup>
import MypageLayout from '@/components/layouts/MypageLayout.vue';
import PasswordChangeModal from '@/components/modal/PasswordChangeModal.vue';
import { computed, ref, onMounted } from 'vue';
import axios from 'axios';
import router from '@/router';
import { useUserStore } from '@/stores/userStore';

const userStore = useUserStore();

const BASEURL = '/api';
const showPasswordChangeModal = ref(false);
const isEditing = ref(false);
const editedNickname = ref('');

const alarmLabels = {
  pushAlarm: '푸시 알림',
  emailAlarm: '이메일 알림',
  payAlarm: '결제 예정 알림',
};

const modiNickname = () => {
  isEditing.value = true;
};

const saveNickname = async () => {
  try {
    const updatedUser = {
      ...user.value,
      nickname: editedNickname.value,
    };

    const response = await axios.put(
      `${BASEURL}users/${user.value.id}`,
      updatedUser
    );

    if (response.status === 200) {
      user.value.nickname = editedNickname.value;
      isEditing.value = false;
    } else {
      alert('닉네임 수정에 실패했습니다.');
    }
  } catch (error) {
    console.error('닉네임 수정 오류:', error);
    alert('서버 오류로 수정할 수 없습니다.');
  }
};

const deleteUser = async () => {
  const userId = user.value.id;

  if (!confirm('정말 탈퇴하시겠습니까?')) return;

  try {
    await axios.delete(`${BASEURL}users/${userId}`);

    //로컬 정보 초기화
    localStorage.removeItem('userId');
    user.value = null;
    router.push('/');
  } catch (error) {
    console.log(error, '탈퇴 실패');
  }
};

onMounted(async () => {
  const storedId = localStorage.getItem('userId');
  console.log('✅ storedId:', storedId);

  if (!storedId) {
    console.warn('⚠️ userId가 없음 → 로그인 페이지로 이동');
    router.push('/login');
    return;
  }

  try {
    await userStore.fetchUser(storedId);
    console.log('👤 불러온 유저 정보:', userStore.user);
  } catch (e) {
    console.error('❌ fetchUser 실패:', e);
  }
});

const user = computed(() => userStore.user);

// 옵셔널 체이닝을 이용해 null 방지
const email = computed(() => user.value?.email || '');
const nickname = computed(() => user.value?.nickname || '');
const joinDate = computed(() => user.value?.joinDate || '');
</script>

<style scoped>
.switch-setting {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin-bottom: 0.5rem;
}
.btn-modi {
  margin-left: auto;
}
.user-image {
  background-color: rgb(212, 212, 212);
  border-radius: 50px;
  height: 70px;
  width: 70px;
  margin-right: 0.75rem;
}
.user-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.info {
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.user-name {
  font-size: small;
  margin-bottom: 0.1rem;
}
.user-email {
  font-size: 8px;
  margin-bottom: 0.1rem;
}
.user-join-date {
  font-size: 8px;
  margin-bottom: 0.1rem;
}
.btn {
  text-align: left;
  font-size: small;
  cursor: pointer;
}
.btn-logout {
  background-color: #fef2f2;
  color: red;
  border: 0;
}
.btn-passwordChange {
  background-color: #f3f4f6;
}
.btn-out {
  color: #6b7280;
  font-size: x-small;
}
.pointer {
  cursor: pointer;
}
</style>
